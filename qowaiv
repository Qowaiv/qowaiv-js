#!/usr/bin/env nu

def main [] {
    ./qowaiv --help    
}

# build qowaiv package
def "main build" [] {
    npm run build
}

# Test the qowaiv package
def "main test" [] {
    npm run test
}

def "main publish" [
    tag: string # The tag of the image (e.g., 0.0.1)!
] {
    print "Update package.json with version tag: '$tag'"
    open package.json | update version $tag | save package.json -f

    print "Build and test the package"
    main build
    main test


    if 'GITHUB_TOKEN' not-in $env {
        print "Set the GITHUB_TOKEN environment variable"
        $env.GITHUB_TOKEN = (gh auth token)
    }

    print "Add the GITHUB_TOKEN to the .npmrc file"
    (
        "//npm.pkg.github.com/:_authToken=" + $env.GITHUB_TOKEN + "\n\r"
             | save --append .npmrc -f
    )

    print "Publish the package to Github registry"   
    npm publish
}

def "main release" [
    tag: string # The tag of the image (e.g., 0.0.1)!
] {
    print "Update package.json with version tag: '$tag'"
    open package.json | update version $tag | save package.json -f

    print "Build and test the package"
    main build
    main test

    (
        print "Add the NODE_AUTH_TOKEN to the .npmrc file"
        "//registry.npmjs.org/:_authToken=" + $env.NODE_AUTH_TOKEN + "\n\r"
             | save --append .npmrc -f
    )
           
    print "Publish the package NPM registry"
    npm publish --access public
}